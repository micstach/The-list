<!DOCTYPE html>
<html ng-app="Index">
  <head>

    <script>
      function getTimeString(timestamp)
      {
        var now = Date.now() ;
        var time = new Date(timestamp) ;

        var seconds = Math.floor((now - timestamp) / 1000) ;
        var minutes = Math.floor(seconds / 60) ;
        var hours = Math.floor(minutes / 60) ;
        var days = Math.floor(hours / 24) ;
        var weeks = Math.floor(days / 7) ;

        var timeString = 'error';

        if (days > 0) {
          if (days == 1) {
            timeString = '<%= resources.aDayAgo %>';
          } 
          else {
            timeString = days + ' <%= resources.daysAgo %>' ;
          }
        }
        else if (hours > 0) {
          if (hours == 1) {
            timeString = '<%= resources.anHourAgo %>' ;
          } 
          else if (finishesWithArray(hours, [0, 1, 5, 6, 7, 8, 9, 11, 12, 13, 14, 15, 16, 17, 18, 19])) {
            timeString = hours + ' <%= resources.hoursAgo1 %>' ;
          }
          else if (finishesWithArray(hours, [2, 3, 4])) {
            timeString = hours + ' <%= resources.hoursAgo2 %>' ;
          }
        }
        else if (minutes > 0) {
          if (minutes == 1) {
            timeString = '<%= resources.aMinuteAgo %>';
          } 
          else if (finishesWithArray(minutes, [0, 1, 5, 6, 7, 8, 9, 11, 12, 13, 14, 15, 16, 17, 18, 19])) {
            timeString = minutes + ' <%= resources.minutesAgo1 %>';
          }
          else if (finishesWithArray(minutes, [2, 3, 4])) {
            timeString = minutes + ' <%= resources.minutesAgo2 %>';
          }
        }
        else if (seconds < 15) {
          timeString = '<%= resources.justNow %>' ;
        } 
        else if (seconds <= 30) {
          timeString = '<%= resources.halfAMinuteAgo %>' ;
        } 
        else {
          timeString = '<%= resources.almostAMinuteAgo %>' ;
        }
        
        return timeString ;
      }    
    </script>

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="cache-control" content="no-cache" />

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <link rel="icon" type="image/png" sizes="16x16" href="/res/todo_16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/res/todo_32.png">
    <link rel="icon" type="image/png" sizes="64x64" href="/res/todo_64.png">    

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/checkboxes-nojs.css" rel="stylesheet" type="text/css">
    <link href="../css/notes.css" rel="stylesheet" type="text/css">

    <script src="../libs/jquery.min.js"></script>
    <script src="../libs/bootstrap.min.js"></script>
    <script src="../libs/angular.min.js"></script>
    <script src="../libs/angular-animate.js"></script>
    <script src="../libs/angular-linkify.min.js "></script>    
    <script src="../libs/ui-bootstrap-tpls-1.2.1.min.js"></script>
    <script src="../scripts/utils.js"></script>
    <script src="../scripts/todo.js"></script>
    <script src="../scripts/google-analytics.js"></script>
  </head>
  <body ng-controller="Notes">
    
    <div class="application-header">
      <div class="container">
        <button type="button" ng-click="!adding && createNewNote()" class="btn glyphicon glyphicon-plus-sign button-note-add" ng-class="adding ? 'disabled':''"></button>
        <!-- <span>Project name</span> -->
        <!-- <button ng-click="!adding && deleteAllItems()" class="btn glyph-menu-button glyphicon glyphicon-trash" ng-class="adding ? 'disabled':''" type="button" style="color:white;"></button> -->
        <span class="pull-right">
          <% if (locals.desktopClient == true) { %>
          <span class="user" data-toggle="tooltip" data-placement="bottom" title="Witaj <%= username %>!"><%= username %></span>
          <% } else { %>
            <div class="btn-group">
              <button type="button" data-toggle="dropdown" class="btn btn-link btn-md dropdown-toggle" style="text-decoration: none; padding-right: 0px; color:white;"><%= username %> <span class="glyphicon glyphicon-option-vertical"></span></button>
              <ul class="dropdown-menu-right dropdown-menu scrollable-menu">
                <li><a ng-click="deleteAllItems()" href="#"><%= resources.removeAllNotes %></a></li>
                <li role="separator" class="divider"></li>
                <li><a href="/account"><%= resources.accountSettings %></a></li>
                <li><a href="/logoff"><%= resources.logOut %></a></li>
              </ul>
            </div>
          <% } %>
        </span>
        <div id="content-filter-box" class="note-tags-filter">
          <div class="btn-group tags-button">
            <button type="button" class="btn dropdown-toggle glyph-menu-button glyphicon glyphicon-tag" data-toggle="dropdown" ng-class="adding ? 'disabled':''"></button>
            <ul class="dropdown-menu scrollable-menu">
              <li ng-show="selectedTags.length > 0" ng-click="selectTag(null)"><a href="#"><%= resources.resetFilter %></a></li>
              <li ng-show="tags.length > 0 && selectedTags.length > 0" role="separator" class="divider"></li>
              <li ng-show="tags.length > 1 || selectedTags.length > 0" ng-repeat="tag in tags track by $index">
                <a href="#" ng-click="selectTag(tag)">
                  <span class="note-tag-active label" ng-class="IsInternalTag(tag) ? 'label-warning':'label-primary'"><span ng-bind-html="transformTagForView(tag)">{{tag}}</span></span>
                </a>
              </li>
            </ul>
          </div>
          <span ng-show="selectedTags.length > 0" class="tags-selected">
            <span ng-repeat="tag in selectedTags track by $index" class="label note-tag-filter" ng-class="IsInternalTag(tag) ? 'label-warning':'label-primary'"><span ng-bind-html="transformTagForView(tag)">{{tag}}</span>&nbsp;&nbsp;&nbsp;<span class="glyphicon glyphicon-remove-sign" ng-click="cancelFilter(tag)" style="font-size: 100%;"></span></span>
            </span>
          </span>
          <span class="search-box">
            <input type="text" ng-model="searchText" ng-change="searchTextChanged(searchText)" placeholder="<%= resources.searchNotePlaceholder %>" class="input-box" focus-search="true">
          </span>
        </div>
      </div>
    </div>

    <div class="container application-list">
      <ul class="list-group">
        <li ng-repeat="note in data.notes track by $index" ng-class="note.pinned ? 'message-pinned' : (note.checked ? 'message-checked' : '')" id="{{note._id}}" class="list-group-item">
          <div class="message-header">
            <span class="message-header-left">
              <button ng-show="!note.editing" ng-click="toggleItem(note)" ng-class="note.checked ? 'glyphicon-check' : 'glyphicon-unchecked'" class="note-header-icon-nospace glyphicon"></button>
              <span ng-show="!note.editing" class="note-time">{{note.timeVerbose}}</span>
              <span ng-show="note.editing" class="typing-helper">*<b><%= resources.boldText %></b>*, _<i><%= resources.italicText %></i>_, ```<div class="preformated-text-inline"><%= resources.preformatedText %></div>```</span>
            </span>
            <span class="message-header-right">
              <button ng-show="!note.editing" ng-click="pinItem(note)" ng-class="note.pinned ? 'pinned' : 'unpinned'" class="note-header-icon glyphicon glyphicon-flag"></button>
              <button ng-show="!note.editing" ng-click="enterEditingMode(note)" class="note-header-icon glyphicon glyphicon-edit"></button>
              <button ng-show="!note.editing" ng-click="deleteItem(note)" class="note-header-icon glyphicon glyphicon-trash"></button>
              <button ng-show="note.editing" ng-click="acceptChanges(note)"  ng-disabled="!note.modified || note.changeAccepted" ng-class="note.modified ? 'note-edit-accept' : 'note-edit-accept-disabled'" class="note-header-icon glyphicon glyphicon-plus-sign"></button> 
              <button ng-show="note.editing && (note.text.length > 0 || data.notes.length > 1)" ng-click="cancelChanges(null, note)" ng-disable="note.changeAccepted" class="note-header-icon note-edit-cancel glyphicon glyphicon-remove-sign"></button> 
            </span>  
          </div>
          <div ng-show="!note.editing" ng-bind-html="note.outputText" ng-model="note.outputText" ng-class="note.pinned ? 'note-text-pinned' : 'note-text'">{{note.outputText}}</div>
          <form ng-show="note.editing" ng-keyup="cancelModifyMode($event, note)" class="form-inline">
            <textarea ng-attr-id="{{'note-id-' + (note._id !== undefined ? note._id : 'undefined') }}" ng-model="note.text" ng-change="noteTextChanged(note)" ng-trim="false" class="form-control input-default note-edit-input" focus="note.editing" id="note-edit-{{note._id}}" placeholder="<%= resources.notePlaceholder %>">{{note.text}}</textarea>
          </form>
          <div ng-show="note.tags.length > 0 || note.newTags.length > 0" class="note-tags">
            <span ng-repeat="tag in note.tags track by $index" ng-click="!note.editing && selectTag(tag)" ng-class="{'note-tag-inactive': note.editing, 'note-tag-active': !note.editing, 'label-info': selectedTags.indexOf(tag) == -1, 'label-primary' : selectedTags.indexOf(tag) !== -1 }" class="label">{{tag}}<span ng-show="note.editing">&nbsp;&nbsp;&nbsp;</span><span ng-show="note.editing" class="glyphicon glyphicon-remove-sign" ng-click="deleteTag(note, tag)" style="font-size: 100%;"></span></span></span>
            <span ng-repeat="tag in note.newTags track by $index" ng-click="!note.editing && selectTag(tag)" ng-class="note.editing ? ' note-tag-inactive' : 'note-tag-active'" class="label label-warning">{{tag}}</span>
          </div>
        </li>
      </ul> 
    </div>
  </body>
</html>
